import sys, os
import streamlit as st
from datetime import datetime
import json
import requests
from bs4 import BeautifulSoup
import re
import time
from urllib.parse import quote
import hashlib

# ‚úÖ permet d'acc√©der √† utils.py √† la racine
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))

from utils import (
    init_session_state,
    PDF_AVAILABLE,
    WORD_AVAILABLE,
    save_briefs,
    load_briefs,
    export_brief_pdf,
    export_brief_word,
    generate_checklist_advice,
    filter_briefs,
    generate_automatic_brief_name,
)

# -------------------- FONCTIONS SOURCING --------------------
def generate_boolean_query(poste, synonymes, competences_obligatoires, 
                          competences_optionnelles, exclusions, localisation, secteur):
    """G√©n√®re une requ√™te boolean"""
    query_parts = []
    if poste: query_parts.append(f'"{poste}"')
    if synonymes: query_parts.append(f'("{synonymes}")')
    if competences_obligatoires: query_parts.append(f'("{competences_obligatoires}")')
    if competences_optionnelles: query_parts.append(f'("{competences_optionnelles}" OR "{competences_optionnelles}")')
    if localisation: query_parts.append(f'"{localisation}"')
    if secteur: query_parts.append(f'"{secteur}"')
    if exclusions: query_parts.append(f'NOT ("{exclusions}")')
    
    return " AND ".join(query_parts)

def generate_xray_query(site_cible, poste, mots_cles, localisation):
    """G√©n√®re une requ√™te X-Ray"""
    site_map = {"LinkedIn": "site:linkedin.com/in", "GitHub": "site:github.com"}
    site = site_map.get(site_cible, "site:linkedin.com/in")
    
    query_parts = [site]
    if poste: query_parts.append(f'"{poste}"')
    if mots_cles: query_parts.append(f'"{mots_cles}"')
    if localisation: query_parts.append(f'"{localisation}"')
    
    return " ".join(query_parts)

def ask_deepseek(messages, max_tokens=300):
    """Simule l'appel √† l'API DeepSeek"""
    time.sleep(1)  # Simulation de d√©lai
    question = messages[0]["content"].lower()
    
    if "synonymes" in question:
        return {"content": "Ing√©nieur travaux, Chef de chantier, Conducteur de travaux, Responsable de projet BTP, Manager construction"}
    elif "outils" in question or "logiciels" in question:
        return {"content": "‚Ä¢ AutoCAD\n‚Ä¢ Revit\n‚Ä¢ Primavera P6\n‚Ä¢ MS Project\n‚Ä¢ Robot Structural Analysis\n‚Ä¢ SketchUp"}
    elif "comp√©tences" in question:
        return {"content": "‚Ä¢ Gestion de projet\n‚Ä¢ Lecture de plans techniques\n‚Ä¢ Management d'√©quipe\n‚Ä¢ Budget et planning\n‚Ä¢ Conformit√© r√©glementaire\n‚Ä¢ N√©gociation fournisseurs"}
    else:
        return {"content": "Voici des informations pertinentes concernant votre demande. N'h√©sitez pas √† pr√©ciser votre question pour une r√©ponse plus cibl√©e."}

def get_email_from_charika(entreprise):
    """Simule la d√©tection de format d'email depuis Charika"""
    formats = [
        "prenom.nom@entreprise.com",
        "pnom@entreprise.com",
        "prenom@entreprise.com",
        "nom.prenom@entreprise.com",
        "initialenom@entreprise.com"
    ]
    return formats[0]

def save_library_entries():
    """Sauvegarde les entr√©es de la biblioth√®que (simulation)"""
    pass

# ---------------- FONCTIONS BRIEF EXISTANTES ----------------
def conseil_button(titre, categorie, conseil, key):
    """Cr√©e un bouton avec conseil pour un champ"""
    col1, col2 = st.columns([4, 1])
    with col1:
        st.text_area(titre, key=key)
    with col2:
        if st.button("üí°", key=f"btn_{key}"):
            st.session_state[key] = generate_checklist_advice(categorie, titre)
            st.rerun()

def render_ksa_section():
    """Affiche la section KSA (Knowledge, Skills, Abilities)"""
    st.info("Matrice des comp√©tences requises (KSA)")
    
    if "ksa_data" not in st.session_state:
        st.session_state.ksa_data = {
            "Connaissances": {},
            "Comp√©tences": {},
            "Aptitudes": {}
        }
    
    with st.expander("‚ûï Ajouter une comp√©tence"):
        col1, col2, col3 = st.columns(3)
        with col1:
            new_cat = st.selectbox("Cat√©gorie", ["Connaissances", "Comp√©tences", "Aptitudes"], key="new_cat")
        with col2:
            new_comp = st.text_input("Comp√©tence", key="new_comp")
        with col3:
            new_score = st.slider("Importance", 1, 5, 3, key="new_score")
        
        if st.button("Ajouter", key="add_comp"):
            if new_comp:
                st.session_state.ksa_data[new_cat][new_comp] = {"score": new_score}
                st.success(f"‚úÖ {new_comp} ajout√© √† {new_cat}")
                st.rerun()
    
    for categorie, competences in st.session_state.ksa_data.items():
        with st.expander(f"{categorie} ({len(competences)})"):
            if competences:
                for comp, details in competences.items():
                    col1, col2, col3 = st.columns([3, 1, 1])
                    with col1:
                        st.write(f"**{comp}**")
                    with col2:
                        st.write(f"Importance: {details.get('score', 'N/A')}/5")
                    with col3:
                        if st.button("üóëÔ∏è", key=f"del_{categorie}_{comp}"):
                            del st.session_state.ksa_data[categorie][comp]
                            st.rerun()
            else:
                st.info("Aucune comp√©tence d√©finie")

# ---------------- INITIALISATION --------------------
init_session_state()

# Initialiser les variables de sourcing
sourcing_defaults = {
    "api_usage": {"current_session_tokens": 0, "used_tokens": 0},
    "library_entries": [],
    "magicien_history": [],
    "boolean_query": "",
    "xray_query": "",
    "cse_query": "",
    "dogpile_query": "",
    "scraper_result": "",
    "scraper_emails": set(),
    "inmail_message": "",
    "perm_result": [],
    "inmail_objet": "",
    "inmail_generated": False,
    "inmail_profil_data": {},
}

for k, v in sourcing_defaults.items():
    if k not in st.session_state:
        st.session_state[k] = v

st.set_page_config(page_title="TG-Hire IA - Brief", page_icon="ü§ñ", layout="wide")

if "brief_phase" not in st.session_state:
    st.session_state.brief_phase = "üìÅ Gestion"

if "sourcing_tab" not in st.session_state:
    st.session_state.sourcing_tab = "üîç Boolean"

if "reunion_step" not in st.session_state:
    st.session_state.reunion_step = 1

if "filtered_briefs" not in st.session_state:
    st.session_state.filtered_briefs = {}

# ---------------- NAVIGATION PRINCIPALE ----------------
st.title("üí° Briefs") 

# ============ ONGLETS DE SOURCING EN HAUT ============
st.markdown("### Outils de Sourcing")

# Onglets de sourcing
sourcing_tabs = [
    "üîç Boolean", "üéØ X-Ray", "üîé CSE LinkedIn", "üê∂ Dogpile", 
    "üï∑Ô∏è Web Scraper", "‚úâÔ∏è InMail", "ü§ñ Magicien", "üìß Permutateur", "üìö Biblioth√®que"
]

# CSS pour les onglets de sourcing
st.markdown("""
    <style>
    .sourcing-nav {
        border-bottom: 2px solid #0066cc;
        margin-bottom: 20px;
        padding-bottom: 10px;
    }
    .sourcing-nav .stButton > button {
        background-color: #0066cc !important;
        color: white !important;
        border: none !important;
        margin-right: 5px !important;
        border-radius: 5px !important;
        font-size: 12px !important;
        padding: 5px 8px !important;
    }
    .sourcing-nav .stButton > button:hover {
        background-color: #0052a3 !important;
    }
    .active-sourcing-tab {
        background-color: #004d99 !important;
        font-weight: bold !important;
    }
    </style>
""", unsafe_allow_html=True)

# Navigation des onglets de sourcing
with st.container():
    st.markdown('<div class="sourcing-nav">', unsafe_allow_html=True)
    cols_sourcing = st.columns(len(sourcing_tabs))
    
    for i, tab_name in enumerate(sourcing_tabs):
        with cols_sourcing[i]:
            if st.button(tab_name, key=f"sourcing_{i}"):
                st.session_state.sourcing_tab = tab_name
                st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

# ============ CONTENU DES ONGLETS DE SOURCING ============
if st.session_state.sourcing_tab == "üîç Boolean":
    st.header("üîç Recherche Boolean")
    col1, col2 = st.columns(2)
    with col1:
        poste = st.text_input("Poste recherch√©:", key="boolean_poste", placeholder="Ex: Ing√©nieur de travaux")
        synonymes = st.text_input("Synonymes:", key="boolean_synonymes", placeholder="Ex: Conducteur de travaux, Chef de chantier")
        competences_obligatoires = st.text_input("Comp√©tences obligatoires:", key="boolean_comp_oblig", placeholder="Ex: Autocad, Robot Structural Analysis")
        secteur = st.text_input("Secteur d'activit√©:", key="boolean_secteur", placeholder="Ex: BTP, Construction")
    with col2:
        competences_optionnelles = st.text_input("Comp√©tences optionnelles:", key="boolean_comp_opt", placeholder="Ex: Primavera, ArchiCAD")
        exclusions = st.text_input("Mots √† exclure:", key="boolean_exclusions", placeholder="Ex: Stage, Alternance")
        localisation = st.text_input("Localisation:", key="boolean_loc", placeholder="Ex: Casablanca")
        employeur = st.text_input("Employeur:", key="boolean_employeur", placeholder="Ex: TGCC")

    if st.button("ü™Ñ G√©n√©rer la requ√™te Boolean", type="primary", use_container_width=True, key="boolean_generate"):
        with st.spinner("‚è≥ G√©n√©ration en cours..."):
            start_time = time.time()
            st.session_state["boolean_query"] = generate_boolean_query(
                poste, synonymes, competences_obligatoires,
                competences_optionnelles, exclusions, localisation, secteur
            )
            if employeur:
                st.session_state["boolean_query"] += f' AND ("{employeur}")'
            total_time = time.time() - start_time
            st.success(f"‚úÖ Requ√™te g√©n√©r√©e en {total_time:.1f}s")

    if st.session_state.get("boolean_query"):
        st.text_area("Requ√™te Boolean:", value=st.session_state["boolean_query"], height=120, key="boolean_area")
        
        col1, col2 = st.columns([1, 2])
        with col1:
            if st.button("üíæ Sauvegarder", key="boolean_save", use_container_width=True):
                entry = {
                    "date": datetime.now().strftime("%Y-%m-%d %H:%M"), 
                    "type": "Boolean", 
                    "poste": poste, 
                    "requete": st.session_state["boolean_query"]
                }
                st.session_state.library_entries.append(entry)
                save_library_entries()
                st.success("‚úÖ Sauvegard√©")
        with col2:
            url_linkedin = f"https://www.linkedin.com/search/results/people/?keywords={quote(st.session_state['boolean_query'])}"
            st.link_button("üåê Ouvrir sur LinkedIn", url_linkedin, use_container_width=True)

elif st.session_state.sourcing_tab == "üéØ X-Ray":
    st.header("üéØ X-Ray Google")
    col1, col2 = st.columns(2)
    with col1:
        site_cible = st.selectbox("Site cible:", ["LinkedIn", "GitHub"], key="xray_site")
        poste_xray = st.text_input("Poste:", key="xray_poste", placeholder="Ex: D√©veloppeur Python")
        mots_cles = st.text_input("Mots-cl√©s:", key="xray_mots_cles", placeholder="Ex: Django, Flask")
    with col2:
        localisation_xray = st.text_input("Localisation:", key="xray_loc", placeholder="Ex: Casablanca")
        exclusions_xray = st.text_input("Mots √† exclure:", key="xray_exclusions", placeholder="Ex: Stage, Junior")

    if st.button("üîç Construire X-Ray", type="primary", use_container_width=True, key="xray_build"):
        with st.spinner("‚è≥ G√©n√©ration en cours..."):
            start_time = time.time()
            st.session_state["xray_query"] = generate_xray_query(site_cible, poste_xray, mots_cles, localisation_xray)
            if exclusions_xray:
                st.session_state["xray_query"] += f' -("{exclusions_xray}")'
            total_time = time.time() - start_time
            st.success(f"‚úÖ Requ√™te g√©n√©r√©e en {total_time:.1f}s")

    if st.session_state.get("xray_query"):
        st.text_area("Requ√™te X-Ray:", value=st.session_state["xray_query"], height=120, key="xray_area")
        url = f"https://www.google.com/search?q={quote(st.session_state['xray_query'])}"
        col1, col2, col3 = st.columns([1, 2, 2])
        with col1:
            if st.button("üíæ Sauvegarder", key="xray_save", use_container_width=True):
                entry = {
                    "date": datetime.now().strftime("%Y-%m-%d %H:%M"), 
                    "type": "X-Ray",
                    "poste": poste_xray, 
                    "requete": st.session_state["xray_query"]
                }
                st.session_state.library_entries.append(entry)
                save_library_entries()
                st.success("‚úÖ Sauvegard√©")
        with col2:
            st.link_button("üåê Ouvrir sur Google", url, use_container_width=True)
        with col3:
            st.link_button("üîé Recherche avanc√©e", f"https://www.google.com/advanced_search?q={quote(st.session_state['xray_query'])}", use_container_width=True)

elif st.session_state.sourcing_tab == "üîé CSE LinkedIn":
    st.header("üîé CSE LinkedIn")
    col1, col2 = st.columns(2)
    with col1:
        poste_cse = st.text_input("Poste recherch√©:", key="cse_poste", placeholder="Ex: D√©veloppeur Python")
        competences_cse = st.text_input("Comp√©tences cl√©s:", key="cse_comp", placeholder="Ex: Django, Flask")
    with col2:
        localisation_cse = st.text_input("Localisation:", key="cse_loc", placeholder="Ex: Casablanca")
        entreprise_cse = st.text_input("Entreprise:", key="cse_ent", placeholder="Ex: TGCC")

    if st.button("üîç Lancer recherche CSE", type="primary", use_container_width=True, key="cse_search"):
        with st.spinner("‚è≥ Construction de la requ√™te..."):
            start_time = time.time()
            query_parts = []
            if poste_cse: query_parts.append(poste_cse)
            if competences_cse: query_parts.append(competences_cse)
            if localisation_cse: query_parts.append(localisation_cse)
            if entreprise_cse: query_parts.append(entreprise_cse)
            st.session_state["cse_query"] = " ".join(query_parts)
            total_time = time.time() - start_time
            st.success(f"‚úÖ Requ√™te g√©n√©r√©e en {total_time:.1f}s")

    if st.session_state.get("cse_query"):
        st.text_area("Requ√™te CSE:", value=st.session_state["cse_query"], height=100, key="cse_area")
        col1, col2 = st.columns([1, 2])
        with col1:
            if st.button("üíæ Sauvegarder", key="cse_save", use_container_width=True):
                entry = {
                    "date": datetime.now().strftime("%Y-%m-%d %H:%M"), 
                    "type": "CSE", 
                    "poste": poste_cse, 
                    "requete": st.session_state["cse_query"]
                }
                st.session_state.library_entries.append(entry)
                save_library_entries()
                st.success("‚úÖ Sauvegard√©")
        with col2:
            cse_url = f"https://cse.google.fr/cse?cx=004681564711251150295:d-_vw4klvjg&q={quote(st.session_state['cse_query'])}"
            st.link_button("üåê Ouvrir sur CSE", cse_url, use_container_width=True)

elif st.session_state.sourcing_tab == "üê∂ Dogpile":
    st.header("üê∂ Dogpile Search")
    query = st.text_input("Requ√™te Dogpile:", key="dogpile_query_input", placeholder="Ex: Python developer Casablanca")
    if st.button("üîç Rechercher", key="dogpile_search_btn", type="primary", use_container_width=True):
        if query:
            st.session_state["dogpile_query"] = query
            st.success("‚úÖ Requ√™te enregistr√©e")
    if st.session_state.get("dogpile_query"):
        st.text_area("Requ√™te Dogpile:", value=st.session_state["dogpile_query"], height=80, key="dogpile_area")
        col1, col2 = st.columns([1, 2])
        with col1:
            if st.button("üíæ Sauvegarder", key="dogpile_save_btn", use_container_width=True):
                entry = {
                    "date": datetime.now().strftime("%Y-%m-%d %H:%M"), 
                    "type": "Dogpile", 
                    "poste": "Recherche Dogpile", 
                    "requete": st.session_state["dogpile_query"]
                }
                st.session_state.library_entries.append(entry)
                save_library_entries()
                st.success("‚úÖ Sauvegard√©")
        with col2:
            dogpile_url = f"http://www.dogpile.com/serp?q={quote(st.session_state['dogpile_query'])}"
            st.link_button("üåê Ouvrir sur Dogpile", dogpile_url, use_container_width=True)

elif st.session_state.sourcing_tab == "üï∑Ô∏è Web Scraper":
    st.header("üï∑Ô∏è Web Scraper")
    choix = st.selectbox("Choisir un objectif:", [
        "Veille salariale & march√©",
        "Intelligence concurrentielle",
        "Contact personnalis√©",
        "Collecte de CV / emails / t√©l√©phones"
    ], key="scraper_choice")
    url = st.text_input("URL √† analyser:", key="scraper_url", placeholder="https://exemple.com")
    if st.button("üöÄ Scraper", use_container_width=True, key="scraper_btn"):
        if url:
            try:
                with st.spinner("‚è≥ Scraping en cours..."):
                    start_time = time.time()
                    r = requests.get(url, headers={"User-Agent": "Mozilla/5.0"}, timeout=10)
                    soup = BeautifulSoup(r.text, "html.parser")
                    texte = soup.get_text()[:1200]
                    emails = set(re.findall(r"[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}", texte))
                    st.session_state["scraper_result"] = texte
                    st.session_state["scraper_emails"] = emails
                    total_time = time.time() - start_time
                    st.success(f"‚úÖ Scraping termin√© en {total_time:.1f}s - {len(emails)} email(s) trouv√©(s)")
            except Exception as e:
                st.error(f"‚ùå Erreur scraping : {e}")
    if st.session_state.get("scraper_result"):
        st.text_area("Extrait du contenu:", value=st.session_state["scraper_result"], height=200, key="scraper_area")
        if st.session_state.get("scraper_emails"):
            st.info("üìß Emails d√©tect√©s: " + ", ".join(st.session_state["scraper_emails"]))

elif st.session_state.sourcing_tab == "‚úâÔ∏è InMail":
    st.header("‚úâÔ∏è G√©n√©rateur d'InMail Personnalis√©")
    st.info("Fonctionnalit√© InMail int√©gr√©e - Version simplifi√©e")
    
    col1, col2 = st.columns(2)
    with col1:
        url_linkedin = st.text_input("Profil LinkedIn", key="inmail_url_brief", placeholder="linkedin.com/in/nom-prenom")
        poste_accroche = st.text_input("Poste √† pourvoir", key="inmail_poste_brief", placeholder="Ex: Directeur Financier")
    with col2:
        entreprise = st.selectbox("Entreprise", ["TGCC", "TG ALU", "TG COVER", "TG WOOD", "TG STEEL", "TG STONE", "TGEM", "TGCC Immobilier"], key="inmail_entreprise_brief")
        ton_message = st.selectbox("Ton du message", ["Persuasif", "Professionnel", "Convivial", "Direct"], key="inmail_ton_brief")
    
    if st.button("‚ú® G√©n√©rer InMail", type="primary", use_container_width=True, key="generate_inmail_brief"):
        if poste_accroche and entreprise:
            message_simple = f"""Bonjour,

Votre profil sur LinkedIn a retenu mon attention, particuli√®rement votre exp√©rience dans le domaine.

Je me permets de vous contacter concernant une opportunit√© de {poste_accroche} au sein de {entreprise}. Votre expertise serait un atout pr√©cieux pour notre √©quipe.

Seriez-vous ouvert √† un √©change pour discuter de cette opportunit√© ?

Dans l'attente de votre retour,"""
            
            st.text_area("Message InMail g√©n√©r√©:", value=message_simple, height=200, key="inmail_result_brief")
        else:
            st.error("Veuillez remplir au minimum le poste et l'entreprise")

elif st.session_state.sourcing_tab == "ü§ñ Magicien":
    st.header("ü§ñ Magicien de sourcing")

    questions_pretes = [
        "Quels sont les synonymes possibles pour le m√©tier de",
        "Quels outils ou logiciels sont li√©s au m√©tier de",
        "Quels mots-cl√©s pour cibler les juniors pour le poste de",
        "Quels intitul√©s similaires au poste de",
        "Quels crit√®res √©liminatoires fr√©quents pour le poste de",
    ]

    q_choice = st.selectbox("üìå Questions pr√™tes :", [""] + questions_pretes, key="magicien_qchoice_brief")
    
    if q_choice:
        default_question = q_choice
    else:
        default_question = ""
    
    question = st.text_area("Modifiez la question si n√©cessaire :", 
                          value=default_question, 
                          key="magicien_question_brief", 
                          height=100,
                          placeholder="Posez votre question ici...")

    if st.button("‚ú® Poser la question", type="primary", key="ask_magicien_brief", use_container_width=True):
        if question:
            with st.spinner("‚è≥ G√©n√©ration en cours..."):
                start_time = time.time()
                result = ask_deepseek([{"role": "user", "content": question}], max_tokens=300)
                total_time = int(time.time() - start_time)
                st.success(f"‚úÖ R√©ponse g√©n√©r√©e en {total_time}s")
                
                st.session_state.magicien_history.append({
                    "q": question, 
                    "r": result["content"], 
                    "time": total_time
                })
                
                st.text_area("R√©ponse:", value=result["content"], height=150, key=f"magicien_response_{len(st.session_state.magicien_history)}")
        else:
            st.warning("‚ö†Ô∏è Veuillez poser une question")

elif st.session_state.sourcing_tab == "üìß Permutateur":
    st.header("üìß Permutateur Email")

    col1, col2 = st.columns(2)
    with col1:
        prenom = st.text_input("Pr√©nom:", key="perm_prenom_brief", placeholder="Jean")
        nom = st.text_input("Nom:", key="perm_nom_brief", placeholder="Dupont")
    with col2:
        entreprise = st.text_input("Entreprise:", key="perm_entreprise_brief", placeholder="TGCC")

    if st.button("üîÆ G√©n√©rer permutations", use_container_width=True, key="perm_generate_brief"):
        if prenom and nom and entreprise:
            with st.spinner("‚è≥ G√©n√©ration des permutations..."):
                domain = f"{entreprise.lower().replace(' ', '')}.ma"
                
                patterns = [
                    f"{prenom.lower()}.{nom.lower()}@{domain}",
                    f"{prenom[0].lower()}{nom.lower()}@{domain}",
                    f"{nom.lower()}.{prenom.lower()}@{domain}",
                    f"{prenom.lower()}{nom.lower()}@{domain}",
                    f"{prenom.lower()}-{nom.lower()}@{domain}",
                ]
                
                st.session_state["perm_result"] = list(set(patterns))
                st.success(f"‚úÖ {len(patterns)} permutations g√©n√©r√©es")
                
                st.text_area("R√©sultats:", value="\n".join(st.session_state["perm_result"]), height=150, key="perm_results_brief")
        else:
            st.warning("‚ö†Ô∏è Veuillez remplir tous les champs")

elif st.session_state.sourcing_tab == "üìö Biblioth√®que":
    st.header("üìö Biblioth√®que des recherches")
    
    if st.session_state.library_entries:
        st.info(f"üìä {len(st.session_state.library_entries)} recherche(s) sauvegard√©e(s)")
        
        for i, entry in enumerate(st.session_state.library_entries[-5:]):  # Afficher les 5 derni√®res
            with st.expander(f"{entry['date']} - {entry['type']} - {entry['poste']}"):
                st.text_area("Requ√™te:", value=entry['requete'], height=80, key=f"lib_req_{i}")
    else:
        st.info("üìù Aucune recherche sauvegard√©e pour le moment")

# ============ S√âPARATEUR VISUEL ============
st.markdown("---")
st.markdown("### Gestion des Briefs")

# ============ NAVIGATION BRIEFS (existante) ============
onglets = {
    "Gestion": "üìÅ Gestion", 
    "Avant-brief": "üîÑ Avant-brief",
    "R√©union de brief": "‚úÖ R√©union de brief",
    "Synth√®se": "üìù Synth√®se"
}

# Style CSS pour le menu de navigation et les boutons
st.markdown("""
    <style>
    /* Cache les onglets par d√©faut de Streamlit */
    .st-emotion-cache-16ya5a5 { 
        display: none !important;
    }

    /* Conteneur principal des boutons de navigation pour le style de la ligne */
    div[data-testid="stVerticalBlock"] > div:nth-child(2) > div[data-testid="stHorizontalBlock"] {
        border-bottom: 3px solid #ff4b4b; /* Ligne rouge vif */
        padding-bottom: 0px; 
        margin-bottom: 0px; 
    }

    /* Conteneur des colonnes individuelles de navigation */
    div[data-testid="stVerticalBlock"] > div:nth-child(2) > div[data-testid="stHorizontalBlock"] > div[data-testid="stColumn"] {
        flex-grow: 0 !important; /* Emp√™che les colonnes de prendre de l'espace suppl√©mentaire */
        flex-shrink: 0 !important; /* Emp√™che les colonnes de r√©tr√©cir */
        flex-basis: auto !important; /* La taille est bas√©e sur le contenu */
        width: auto !important; /* Largeur automatique */
        padding-left: 0px !important; /* Pas de padding √† gauche */
        padding-right: 0px !important; /* Pas de padding √† droite */
        margin-right: 5px !important; /* Petite marge entre les boutons pour les s√©parer l√©g√®rement */
    }

    /* Styles g√©n√©raux pour tous les boutons de navigation (non-actifs et actifs) */
    .stButton > button {
        background-color: #D20000 !important; /* Rouge plus fonc√© pour les onglets inactifs */
        color: white !important; 
        border: none !important;
        box-shadow: none !important;
        font-size: 14px !important;
        padding: 5px 10px !important; /* R√©duit le padding pour rapprocher texte/bord */
        border-radius: 0px !important; /* Coins carr√©s */
        white-space: nowrap; /* Emp√™che le texte de passer √† la ligne */
        margin: 0 !important; /* Annule toutes les marges */
        display: inline-flex; /* Permet un bon alignement ic√¥ne/texte et le rapprochement */
        align-items: center;
        justify-content: center;
        gap: 5px; /* Espace entre ic√¥ne et texte */
        height: auto !important; /* La hauteur s'ajuste au contenu */
    }
    
    /* Style pour le bouton de navigation ACTIF */
    .stButton > button.active-tab {
        background-color: #ff4b4b !important; /* Rouge vif pour le bouton actif */
        color: white !important;
        font-weight: bold !important;
        border-bottom: 3px solid #ff4b4b !important; /* Ligne rouge vif en dessous */
        margin-bottom: -3px !important; /* Soul√®ve l√©g√®rement pour couvrir la ligne du conteneur */
    }
    </style>
""", unsafe_allow_html=True)

# Cr√©er les colonnes pour les boutons de navigation
cols = st.columns(len(onglets)) 
    
for i, (key_label, full_label) in enumerate(onglets.items()):
    with cols[i]:
        is_active = (st.session_state.brief_phase == full_label)
        
        if st.button(full_label, key=f"tab_{key_label}", use_container_width=False):
            st.session_state.brief_phase = full_label
            st.rerun()
        
        if is_active:
            st.markdown(f"""
                <script>
                var buttonElement = document.querySelector('[data-testid="stVerticalBlock"] > div:nth-child(2) > div[data-testid="stHorizontalBlock"] > div[data-testid="stColumn"]:nth-child({i+1}) button');
                if (buttonElement) {{
                    buttonElement.classList.add("active-tab");
                }}
                </script>
            """, unsafe_allow_html=True)

# ---------------- ONGLET GESTION ----------------
if st.session_state.brief_phase == "üìÅ Gestion":
    col_main, col_side = st.columns([2, 1])
    
    with col_main:
        st.subheader("Informations de base")
        
        # --- INFOS DE BASE (3 colonnes)
        col1, col2, col3 = st.columns(3)
        with col1:
            st.text_input("Intitul√© du poste *", key="poste_intitule")
            st.text_input("Nom du manager *", key="manager_nom")
        with col2:
            st.text_input("Poste √† recruter", key="niveau_hierarchique")
            st.selectbox("Recruteur *", ["", "Zakaria", "Sara", "Sara", "Jalal", "Bouchra", "Ghita"], key="recruteur")
        with col3:
            st.selectbox("Affectation", ["", "Chantier", "Si√®ge"], key="affectation_type")
            st.text_input("Nom de l'affectation", key="affectation_nom")
        
        st.date_input("Date du Brief *", key="date_brief", value=datetime.today().date()) 

        # --- SAUVEGARDE
        if st.button("üíæ Sauvegarder le Brief", type="primary", use_container_width=True):
            if not all([st.session_state.poste_intitule, st.session_state.manager_nom, st.session_state.recruteur, st.session_state.date_brief]):
                st.error("Veuillez remplir tous les champs obligatoires (*)")
            else:
                brief_name = generate_automatic_brief_name()
                if "saved_briefs" not in st.session_state:
                    st.session_state.saved_briefs = {}
                
                st.session_state.saved_briefs[brief_name] = {
                    "poste_intitule": st.session_state.poste_intitule,
                    "manager_nom": st.session_state.manager_nom,
                    "recruteur": st.session_state.recruteur,
                    "date_brief": str(st.session_state.date_brief),
                    "niveau_hierarchique": st.session_state.niveau_hierarchique,
                    "affectation_type": st.session_state.affectation_type,
                    "affectation_nom": st.session_state.affectation_nom,
                    "raison_ouverture": st.session_state.get("raison_ouverture", ""),
                    "impact_strategique": st.session_state.get("impact_strategique", ""),
                    "rattachement": st.session_state.get("rattachement", ""),
                    "defis_principaux": st.session_state.get("defis_principaux", ""),
                    "ksa_data": st.session_state.get("ksa_data", {})
                }
                save_briefs()
                st.success(f"‚úÖ Brief '{brief_name}' sauvegard√© avec succ√®s !")
                st.session_state.current_brief_name = brief_name

    with col_side:
        st.subheader("Recherche & Chargement")
        
        # --- RECHERCHE & CHARGEMENT (2 colonnes)
        col1, col2 = st.columns(2)
        with col1:
            months = ["", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"]
            month = st.selectbox("Mois", months)
            poste = st.text_input("Poste")
        with col2:
            recruteur = st.selectbox("Recruteur", ["", "Zakaria", "Sara", "Jalal", "Bouchra", "Ghita"], key="search_recruteur")
            manager = st.text_input("Manager")
            affectation = st.selectbox("Affectation", ["", "Chantier", "Si√®ge"], key="search_affectation")

        if st.button("üîé Rechercher", type="secondary", use_container_width=True):
            briefs = load_briefs()
            st.session_state.filtered_briefs = filter_briefs(briefs, month, recruteur, poste, manager, affectation)
            if st.session_state.filtered_briefs:
                st.info(f"‚ÑπÔ∏è {len(st.session_state.filtered_briefs)} brief(s) trouv√©(s).")
            else:
                st.error("‚ùå Aucun brief trouv√© avec ces crit√®res.")

        if st.session_state.filtered_briefs:
            st.subheader("R√©sultats de recherche")
            for name, data in st.session_state.filtered_briefs.items():
                with st.expander(f"üìå {name}"):
                    st.write(f"**Poste:** {data.get('poste_intitule', '')}")
                    st.write(f"**Manager:** {data.get('manager_nom', '')}")
                    st.write(f"**Recruteur:** {data.get('recruteur', '')}")
                    st.write(f"**Affectation:** {data.get('affectation_type', '')} - {data.get('affectation_nom', '')}")
                    st.write(f"**Date:** {data.get('date_brief', '')}")
                    
                    colA, colB = st.columns(2)
                    with colA:
                        if st.button(f"üìÇ Charger", key=f"load_{name}"):
                            safe_keys = [k for k in data.keys() if k not in ['ksa_data'] or data[k]]
                            for k in safe_keys:
                                if k in data and data[k]:
                                    st.session_state[k] = data[k]
                            st.session_state.current_brief_name = name
                            st.success(f"‚úÖ Brief '{name}' charg√© avec succ√®s!")
                            st.rerun()
                    with colB:
                        if st.button(f"üóëÔ∏è Supprimer", key=f"del_{name}"):
                            all_briefs = load_briefs()
                            if name in all_briefs:
                                del all_briefs[name]
                                st.session_state.saved_briefs = all_briefs
                                save_briefs()
                                if name in st.session_state.filtered_briefs:
                                    del st.session_state.filtered_briefs[name]
                                st.warning(f"‚ùå Brief '{name}' supprim√©.")
                                st.rerun()

# ---------------- AVANT-BRIEF ----------------
elif st.session_state.brief_phase == "üîÑ Avant-brief":
    st.subheader("üîÑ Avant-brief (Pr√©paration)")
    st.info("Remplissez les informations pr√©paratoires avant la r√©union avec le manager.")

    conseil_button("Raison ouverture", "Contexte", "Pourquoi ce poste est-il ouvert?", key="raison_ouverture")
    conseil_button("Impact strat√©gique", "Contexte", "Impact strat√©gique du poste", key="impact_strategique")
    st.text_area("Rattachement hi√©rarchique", key="rattachement")
    st.text_area("D√©fis principaux", key="defis_principaux")

    if st.button("üíæ Sauvegarder Avant-brief", type="primary", use_container_width=True):
        if "current_brief_name" in st.session_state and st.session_state.current_brief_name in st.session_state.saved_briefs:
            brief_name = st.session_state.current_brief_name
            st.session_state.saved_briefs[brief_name].update({
                "raison_ouverture": st.session_state.get("raison_ouverture", ""),
                "impact_strategique": st.session_state.get("impact_strategique", ""),
                "rattachement": st.session_state.get("rattachement", ""),
                "defis_principaux": st.session_state.get("defis_principaux", "")
            })
            save_briefs()
            st.success("‚úÖ Modifications sauvegard√©es")
        else:
            st.error("‚ùå Veuillez d'abord cr√©er et sauvegarder un brief dans l'onglet Gestion")

# ---------------- R√âUNION (Wizard interne) ----------------
elif st.session_state.brief_phase == "‚úÖ R√©union de brief":
    st.subheader("‚úÖ R√©union de brief avec le Manager")

    total_steps = 4
    step = st.session_state.reunion_step
    st.progress(int((step / total_steps) * 100), text=f"√âtape {step}/{total_steps}")

    if step == 1:
        st.subheader("1Ô∏è‚É£ Incidents Critiques")
        st.text_area("R√©ussite exceptionnelle - Contexte", key="reussite_contexte")
        st.text_area("R√©ussite exceptionnelle - Actions", key="reussite_actions")
        st.text_area("R√©ussite exceptionnelle - R√©sultat", key="reussite_resultat")
        st.text_area("√âchec significatif - Contexte", key="echec_contexte")
        st.text_area("√âchec significatif - Causes", key="echec_causes")
        st.text_area("√âchec significatif - Impact", key="echec_impact")

    elif step == 2:
        st.subheader("2Ô∏è‚É£ Questions Comportementales")
        st.text_area("Comment le candidat devrait-il g√©rer [situation difficile] ?", key="comp_q1")
        st.text_area("R√©ponse attendue", key="comp_rep1")
        st.text_area("Comp√©tences √©valu√©es", key="comp_eval1")

    elif step == 3:
        st.subheader("3Ô∏è‚É£ Validation Matrice KSA")
        render_ksa_section()

    elif step == 4:
        st.subheader("4Ô∏è‚É£ Strat√©gie Recrutement")
        st.multiselect("Canaux prioritaires", ["LinkedIn", "Jobboards", "Cooptation"], key="canaux_prioritaires")
        st.text_area("Crit√®res d'exclusion", key="criteres_exclusion")
        st.text_area("Processus d'√©valuation (d√©tails)", key="processus_evaluation")

        if st.button("üíæ Enregistrer r√©union", type="primary", use_container_width=True):
            if "current_brief_name" in st.session_state and st.session_state.current_brief_name in st.session_state.saved_briefs:
                brief_name = st.session_state.current_brief_name
                st.session_state.saved_briefs[brief_name].update({
                    "ksa_data": st.session_state.get("ksa_data", {})
                })
                save_briefs()
                st.success("‚úÖ Donn√©es de r√©union sauvegard√©es")
            else:
                st.error("‚ùå Veuillez d'abord cr√©er et sauvegarder un brief dans l'onglet Gestion")

    # ---- Navigation wizard ----
    col1, col2, col3 = st.columns([1, 6, 1])
    with col1:
        if step > 1:
            if st.button("‚¨ÖÔ∏è Pr√©c√©dent"):
                st.session_state.reunion_step -= 1
                st.rerun()
    with col3:
        if step < total_steps:
            if st.button("Suivant ‚û°Ô∏è"):
                st.session_state.reunion_step += 1
                st.rerun()

# ---------------- SYNTH√àSE ----------------
elif st.session_state.brief_phase == "üìù Synth√®se":
    st.subheader("üìù Synth√®se du Brief")
    
    if "current_brief_name" in st.session_state:
        st.success(f"Brief actuel: {st.session_state.current_brief_name}")
    
    st.subheader("R√©sum√© des informations")
    st.json({
        "Poste": st.session_state.get("poste_intitule", ""),
        "Manager": st.session_state.get("manager_nom", ""),
        "Recruteur": st.session_state.get("recruteur", ""),
        "Affectation": f"{st.session_state.get('affectation_type','')} - {st.session_state.get('affectation_nom','')}",
        "Date": str(st.session_state.get("date_brief", "")),
        "Raison ouverture": st.session_state.get("raison_ouverture", ""),
        "Impact strat√©gique": st.session_state.get("impact_strategique", ""),
        "D√©fis principaux": st.session_state.get("defis_principaux", ""),
    })

    st.subheader("üìä Calcul automatique du Score Global")
    score_total = 0
    count = 0
    if "ksa_data" in st.session_state:
        for cat, comps in st.session_state.ksa_data.items():
            for comp, details in comps.items():
                score_total += int(details.get("score") or 0)
                count += 1
    score_global = (score_total / count) if count else 0
    st.metric("Score Global Cible", f"{score_global:.2f}/5")

    if st.button("üíæ Confirmer sauvegarde", type="primary", use_container_width=True):
        if "current_brief_name" in st.session_state:
            save_briefs()
            st.success("‚úÖ Brief final confirm√© et sauvegard√©")
        else:
            st.error("‚ùå Aucun brief √† sauvegarder. Veuillez d'abord cr√©er un brief.")

    # -------- EXPORT PDF/WORD --------
    st.subheader("üìÑ Export du Brief complet")
    col1, col2 = st.columns(2)
    with col1:
        if PDF_AVAILABLE:
            if "current_brief_name" in st.session_state:
                pdf_buf = export_brief_pdf()
                if pdf_buf:
                    st.download_button("‚¨áÔ∏è T√©l√©charger PDF", data=pdf_buf,
                                     file_name=f"{st.session_state.current_brief_name}.pdf", mime="application/pdf")
            else:
                st.info("‚ÑπÔ∏è Cr√©ez d'abord un brief pour l'exporter")
        else:
            st.info("‚ö†Ô∏è PDF non dispo (pip install reportlab)")
    with col2:
        if WORD_AVAILABLE:
            if "current_brief_name" in st.session_state:
                word_buf = export_brief_word()
                if word_buf:
                    st.download_button("‚¨áÔ∏è T√©l√©charger Word", data=word_buf,
                                     file_name=f"{st.session_state.current_brief_name}.docx",
                                     mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document")
            else:
                st.info("‚ÑπÔ∏è Cr√©ez d'abord un brief pour l'exporter")
        else:
            st.info("‚ö†Ô∏è Word non dispo (pip install python-docx)")